<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CSV / XLSX Search System (ALL SHEETS AUTO)</title>

<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=document_search" />
<!-- SheetJS + PapaParse (CDN). ถ้าต้องการ offline ให้ดาวน์โหลดไฟล์ .js มาเก็บ local แล้วเปลี่ยน src -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f4f6f9; margin:0; padding:30px; color:#333; }
.container { max-width:1400px; margin:auto; background:#fff; padding:20px 28px; border-radius:12px; box-shadow:0 6px 30px rgba(0,0,0,0.06);}
h2 { text-align:center; margin-bottom:18px; font-size:22px; font-weight:700; color:#21304a; display:flex; align-items:center; gap:10px; justify-content:center;}
.form-group { display:grid; grid-template-columns:150px 1fr; gap:10px; margin-bottom:12px; align-items:center; }
label { font-weight:600; padding-top:6px;}
input[type=text], input[type=file], select { padding:10px; border:1px solid #d0d7e5; border-radius:8px; font-size:14px; width:100%; box-sizing:border-box; }

#searchBtn {
    display:flex; gap:8px; align-items:center; justify-content:center;
    padding:10px 20px; font-size:16px; border-radius:8px; background:#0066ff;
    color:#fff; border:none; cursor:pointer; margin:20px auto 0 auto;
}
#searchBtn:hover { background:#004ecc; }

table { width:100%; border-collapse:collapse; margin-top:20px; font-size:14px;border-spacing: 0; }
/* มุมบนซ้าย */
table thead th:first-child {
    border-top-left-radius: 10px;
}

/* มุมบนขวา */
table thead th:last-child {
    border-top-right-radius: 10px;
}
/* มุมล่างซ้าย */
table tbody tr:last-child td:first-child {
    border-bottom-left-radius: 10px;
}

/* มุมล่างขวา */
table tbody tr:last-child td:last-child {
    border-bottom-right-radius: 10px;
}
th { background:#0b63ff; color:#fff; padding:10px; position:sticky; top:0; }
td { padding:8px; border-bottom:1px solid #e6eefc; }
tr:nth-child(even){ background:#f8fbff; }

#overlay{
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.4); color:#fff; font-size:20px;
    text-align:center; padding-top:18%; z-index:999;
}
.no-data{ text-align:center; padding:15px; color:#666; }
</style>
</head>
<body>

<div class="container">

<h2><span class="material-symbols-outlined">document_search</span> Information Search System</h2>

    <div class="form-group">
        <label>Select File (.CSV/.XLSX):</label>
        <input type="file" id="dataFile" accept=".csv,.xlsx,.xls">
    </div>

<div class="form-group"><label>Vendor Name:</label><input type="text" id="vendor"></div>
<div class="form-group"><label>JDE Stock No:</label><input type="text" id="jde"></div>
<div class="form-group"><label>SAP Stock No:</label><input type="text" id="sap"></div>
<div class="form-group"><label>Brand:</label><input type="text" id="brand"></div>

<button id="searchBtn"><span class="material-icons">search</span>Search</button>

<div id="output"></div>
</div>

<div id="overlay">Processing...</div>

<script>
/* ------------ Column Aliases ------------- */
const aliasLists = {
  "jde stock no": [
    "jde stock no","jde stock no.","jde","jde no","jde code","jde item no","jde item number",
    "jde sku","jdestockno"
  ],
  "sap stock no": [
    "sap stock no","sap stock no.","sap","sap no","material no","material number","sap item no"
  ],
  "quotation no": [
    "quotation no","quotation no.","quotation number","quote no","quote number","qt no","qtn no"
  ],
  "vendor name": ["vendor name","vendor","supplier name","supplier"],
  "brand": ["brand","manufacturer"],
  "supplier description": ["description","item description","supplier description"],
  "unit price": ["unit price","price","unit cost"],
  "lead time": ["lead time","delivery time"],
  "start date": ["start date","effective date","start"],
  "end date": ["end date","expiry date","expire date","valid to"],
};

/* ------------ Standard Columns ------------ */
const standardColumns = [
  "Vendor Name","JDE Stock No","SAP Stock No","Brand",
  "Supplier Description","Unit Price","Lead Time",
  "Start Date","End Date","Quotation No","Credit Term"
];

/* Helpers */
function norm(s){ return String(s||"").toLowerCase().replace(/[.\-_,]/g,"").trim(); }

function matchHeader(h){
    const key = norm(h);
    for(const std in aliasLists){
        for(const a of aliasLists[std]){
            if(key === norm(a)) return std;
        }
    }
    return null;
}

function escapeHTML(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;"); }

/* Format date */
function ddmmyyyy(v){
    if(!v) return "";
    if(typeof v === "number"){
        let d = XLSX.SSF.parse_date_code(v);
        if(d && d.y) return `${String(d.d).padStart(2,'0')}-${String(d.m).padStart(2,'0')}-${d.y}`;
    }
    let dt = new Date(v);
    if(!isNaN(dt)) return `${String(dt.getDate()).padStart(2,'0')}-${String(dt.getMonth()+1).padStart(2,'0')}-${dt.getFullYear()}`;
    return v;
}

function showOverlay(x){ document.getElementById("overlay").style.display = x ? "block":"none"; }

/* ------------ Global Dataset (all sheets combined) ------------ */
let allData = [];

/* File loader */
document.getElementById("dataFile").addEventListener("change", e=>{
    const file = e.target.files[0];
    if(!file) return;
    showOverlay(true);
    allData = [];

    const ext = file.name.split(".").pop().toLowerCase();
    if(ext === "csv"){
        Papa.parse(file,{
            header:true,
            skipEmptyLines:true,
            complete:(res)=>{ processSheet("CSV", res.data); showOverlay(false); },
            error:(err)=>{ alert(err.message); showOverlay(false); }
        });
    } else {
        const r = new FileReader();
        r.onload = evt=>{
            const wb = XLSX.read(evt.target.result,{type:"array"});
            wb.SheetNames.forEach(name=>{
                const rows = XLSX.utils.sheet_to_json(wb.Sheets[name],{defval:"", raw:false});
                processSheet(name, rows);
            });
            showOverlay(false);
        };
        r.readAsArrayBuffer(file);
    }
});

/* Process a sheet */
function processSheet(name, rows){
    if(rows.length === 0) return;

    const headers = Object.keys(rows[0]);
    const headerMap = {};

    headers.forEach(h=>{
        const std = matchHeader(h);
        if(std) headerMap[std] = h;
        else headerMap[norm(h)] = h;
    });

    rows.forEach(row=>{
        const obj = {};
        standardColumns.forEach(std=>{
            let col = headerMap[std] || headerMap[norm(std)];
            let val = col ? row[col] : "";
            if(std === "Start Date" || std === "End Date") val = ddmmyyyy(val);
            obj[std] = val ?? "";
        });
        allData.push(obj);
    });
}

/* Search Function */
document.getElementById("searchBtn").addEventListener("click", search);

["vendor","jde","sap","brand"].forEach(id=>{
    document.getElementById(id).addEventListener("keydown",e=>{
        if(e.key==="Enter") search();
    });
});

function search(){
    if(allData.length === 0){
        renderNoData("No data found ( Please upload a file )");
        return;
    }

    const vendor = document.getElementById("vendor").value.toLowerCase().trim();
    const jde = document.getElementById("jde").value.toLowerCase().trim();
    const sap = document.getElementById("sap").value.toLowerCase().trim();
    const brand = document.getElementById("brand").value.toLowerCase().trim();

    // ⛔ ถ้าไม่กรอกอะไรเลย → แสดง No data found ในตาราง
    if(!vendor && !jde && !sap && !brand){
        renderNoData("( Please enter search keywords )");
        return;
    }

    const filtered = allData.filter(r =>
        (!vendor || (r["Vendor Name"] && r["Vendor Name"].toLowerCase().includes(vendor))) &&
        (!jde || (r["JDE Stock No"] && r["JDE Stock No"].toLowerCase().includes(jde))) &&
        (!sap || (r["SAP Stock No"] && r["SAP Stock No"].toLowerCase().includes(sap))) &&
        (!brand || (r["Brand"] && r["Brand"].toLowerCase().includes(brand)))
    );

    renderTable(filtered);
}

function renderNoData(msg){
    const out = document.getElementById("output");
    out.innerHTML = `
        <table><thead><tr><th>Result</th></tr></thead>
        <tbody><tr><td class="no-data">${msg}</td></tr></tbody></table>
    `;
}

/* Render */
function renderTable(rows){
    const out = document.getElementById("output");
    if(rows.length === 0){
        out.innerHTML = `
        <table><thead><tr><th>Result</th></tr></thead>
        <tbody><tr><td class="no-data">( No data found )</td></tr></tbody></table>
        `;
        return;
    }

    let html = "<table><thead><tr>";
    standardColumns.forEach(c=> html+=`<th>${escapeHTML(c)}</th>`);
    html += "</tr></thead><tbody>";

    rows.forEach(r=>{
        html += "<tr>";
        standardColumns.forEach(c=> html+=`<td>${escapeHTML(r[c])}</td>`);
        html += "</tr>";
    });

    html += "</tbody></table>";
    out.innerHTML = html;
}
</script>

</body>
</html>
